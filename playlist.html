<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playlist Stats - CarnageReport.com</title>
    <link rel="icon" type="image/x-icon" href="H2CRFinal.ico">
    <link href="https://fonts.googleapis.com/css2?family=Overpass:wght@300;400;600;700&family=Orbitron:wght@400;500;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        .playlist-page {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .playlist-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .playlist-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            color: var(--unsc-blue);
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 5px;
        }
        .playlist-date {
            font-family: 'Share Tech Mono', monospace;
            font-size: 1rem;
            color: rgba(168, 212, 255, 0.7);
            margin-bottom: 10px;
        }
        .playlist-summary {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .summary-stat {
            text-align: center;
            padding: 15px 25px;
            background: rgba(168, 212, 255, 0.05);
            border: 1px solid rgba(168, 212, 255, 0.2);
            border-radius: 8px;
        }
        .summary-stat .value {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            color: var(--unsc-blue);
        }
        .summary-stat .label {
            font-size: 0.85rem;
            color: rgba(168, 212, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Tab Navigation */
        .playlist-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
        }
        .playlist-tab-btn {
            background: rgba(168, 212, 255, 0.1);
            border: 1px solid rgba(168, 212, 255, 0.3);
            color: var(--unsc-blue);
            padding: 12px 24px;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .playlist-tab-btn:hover {
            background: rgba(168, 212, 255, 0.2);
        }
        .playlist-tab-btn.active {
            background: rgba(168, 212, 255, 0.25);
            border-color: var(--unsc-blue);
        }
        .playlist-tab-content {
            display: none;
        }
        .playlist-tab-content.active {
            display: block;
        }

        /* Teams Table */
        .teams-table-container {
            overflow-x: auto;
        }
        .teams-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }
        .teams-table th {
            background: linear-gradient(180deg, rgba(168, 212, 255, 0.15) 0%, rgba(168, 212, 255, 0.05) 100%);
            color: var(--unsc-blue);
            font-family: 'Orbitron', sans-serif;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 15px 12px;
            text-align: left;
            border-bottom: 2px solid rgba(168, 212, 255, 0.3);
        }
        .teams-table td {
            padding: 12px;
            border-bottom: 1px solid rgba(168, 212, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
        }
        .teams-table tr:hover td {
            background: rgba(168, 212, 255, 0.08);
        }
        .teams-table .placement-cell {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .teams-table .placement-icon {
            width: 32px;
            height: 32px;
        }
        .teams-table .team-name {
            color: var(--unsc-blue);
            font-weight: 600;
        }
        .teams-table .team-players {
            font-size: 0.85rem;
            color: rgba(168, 212, 255, 0.7);
        }
        .teams-table .team-players .player-link {
            color: rgba(168, 212, 255, 0.7);
            cursor: pointer;
        }
        .teams-table .team-players .player-link:hover {
            color: var(--unsc-blue);
            text-decoration: underline;
        }
        .positive { color: #4ade80; }
        .negative { color: #f87171; }
        .neutral { color: #fbbf24; }

        /* Stats Table */
        .stats-table-container {
            overflow-x: auto;
        }
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }
        .stats-table th {
            background: linear-gradient(180deg, rgba(168, 212, 255, 0.15) 0%, rgba(168, 212, 255, 0.05) 100%);
            color: var(--unsc-blue);
            font-family: 'Orbitron', sans-serif;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 15px 12px;
            text-align: left;
            border-bottom: 2px solid rgba(168, 212, 255, 0.3);
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }
        .stats-table th:hover {
            background: linear-gradient(180deg, rgba(168, 212, 255, 0.25) 0%, rgba(168, 212, 255, 0.1) 100%);
        }
        .stats-table th.sorted-asc::after {
            content: ' \u25B2';
            font-size: 0.7em;
        }
        .stats-table th.sorted-desc::after {
            content: ' \u25BC';
            font-size: 0.7em;
        }
        .stats-table td {
            padding: 12px;
            border-bottom: 1px solid rgba(168, 212, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
        }
        .stats-table tr:hover td {
            background: rgba(168, 212, 255, 0.08);
        }
        .stats-table .player-cell {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .stats-table .player-emblem {
            width: 32px;
            height: 32px;
            border: 2px solid white;
        }
        .stats-table .player-name {
            color: var(--unsc-blue);
            font-weight: 600;
            cursor: pointer;
        }
        .stats-table .player-name:hover {
            text-decoration: underline;
        }
        .stats-table .rank-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .stats-table .rank-icon {
            width: 28px;
            height: 28px;
        }

        /* Playlist link in game details */
        .playlist-link {
            color: var(--unsc-blue);
            text-decoration: none;
            padding: 4px 10px;
            background: rgba(168, 212, 255, 0.15);
            border-radius: 4px;
            font-size: 0.85rem;
            transition: background 0.2s;
        }
        .playlist-link:hover {
            background: rgba(168, 212, 255, 0.3);
            text-decoration: none;
        }

        /* Games List - mirrors main page */
        .games-list-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--unsc-blue);
            text-decoration: none;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            margin-bottom: 20px;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        .back-link:hover {
            opacity: 1;
        }
        .error-message {
            text-align: center;
            padding: 60px 20px;
            color: #f87171;
            font-family: 'Orbitron', sans-serif;
        }
        .error-message h2 {
            font-size: 1.5rem;
            margin-bottom: 15px;
        }
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--unsc-blue);
            font-family: 'Orbitron', sans-serif;
        }
    </style>
</head>
<body>
    <div class="container">
        <header id="mainHeader">
            <div class="header-icons">
                <a href="https://discord.gg/carnagereport" target="_blank" rel="noopener noreferrer" class="header-icon" title="Join Discord">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 127.14 96.36" fill="currentColor">
                        <path d="M107.7,8.07A105.15,105.15,0,0,0,81.47,0a72.06,72.06,0,0,0-3.36,6.83A97.68,97.68,0,0,0,49,6.83,72.37,72.37,0,0,0,45.64,0,105.89,105.89,0,0,0,19.39,8.09C2.79,32.65-1.71,56.6.54,80.21h0A105.73,105.73,0,0,0,32.71,96.36,77.7,77.7,0,0,0,39.6,85.25a68.42,68.42,0,0,1-10.85-5.18c.91-.66,1.8-1.34,2.66-2a75.57,75.57,0,0,0,64.32,0c.87.71,1.76,1.39,2.66,2a68.68,68.68,0,0,1-10.87,5.19,77,77,0,0,0,6.89,11.1A105.25,105.25,0,0,0,126.6,80.22h0C129.24,52.84,122.09,29.11,107.7,8.07ZM42.45,65.69C36.18,65.69,31,60,31,53s5-12.74,11.43-12.74S54,46,53.89,53,48.84,65.69,42.45,65.69Zm42.24,0C78.41,65.69,73.25,60,73.25,53s5-12.74,11.44-12.74S96.23,46,96.12,53,91.08,65.69,84.69,65.69Z"/>
                    </svg>
                </a>
            </div>
            <a href="/">
                <img src="HaloCarnageReport Logo.png" alt="Carnage Report Logo" class="logo" style="cursor: pointer;">
            </a>
        </header>

        <div class="playlist-page">
            <a href="/" class="back-link">&larr; Back to Main</a>

            <div id="loadingArea" class="loading">
                [ LOADING PLAYLIST STATS ]
            </div>

            <div id="errorArea" class="error-message" style="display: none;">
                <h2>Playlist Not Found</h2>
                <p id="errorText">The requested playlist could not be found.</p>
            </div>

            <div id="contentArea" style="display: none;">
                <div class="playlist-header">
                    <h1 class="playlist-title" id="playlistName"></h1>
                    <div class="playlist-date" id="playlistDate"></div>
                </div>

                <div class="playlist-summary" id="playlistSummary"></div>

                <div class="playlist-tabs" id="playlistTabs">
                    <button class="playlist-tab-btn active" onclick="switchPlaylistTab('teams')">Team Placement</button>
                    <button class="playlist-tab-btn" onclick="switchPlaylistTab('games')">Games List</button>
                    <button class="playlist-tab-btn" onclick="switchPlaylistTab('players')">Player Stats</button>
                </div>

                <!-- Team Placement Tab -->
                <div id="tab-teams" class="playlist-tab-content active">
                    <div class="teams-table-container">
                        <table class="teams-table">
                            <thead>
                                <tr>
                                    <th>Place</th>
                                    <th>Team</th>
                                    <th>Record</th>
                                    <th>Win %</th>
                                </tr>
                            </thead>
                            <tbody id="teamsTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Games List Tab -->
                <div id="tab-games" class="playlist-tab-content">
                    <div class="games-list-container">
                        <div class="game-list" id="playlistGamesList"></div>
                    </div>
                </div>

                <!-- Player Stats Tab -->
                <div id="tab-players" class="playlist-tab-content">
                    <div class="stats-table-container">
                        <table class="stats-table">
                            <thead>
                                <tr id="tableHeader"></tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Map images for game cards
        const mapImages = {
            'Ascension': '/assets/maps/ascension.webp',
            'Beaver Creek': '/assets/maps/beavercreek.webp',
            'Burial Mounds': '/assets/maps/burialmounds.webp',
            'Coagulation': '/assets/maps/coagulation.webp',
            'Colossus': '/assets/maps/colossus.webp',
            'Foundation': '/assets/maps/foundation.webp',
            'Headlong': '/assets/maps/headlong.webp',
            'Ivory Tower': '/assets/maps/ivorytower.webp',
            'Lockout': '/assets/maps/lockout.webp',
            'Midship': '/assets/maps/midship.webp',
            'Sanctuary': '/assets/maps/sanctuary.webp',
            'Turf': '/assets/maps/turf.webp',
            'Warlock': '/assets/maps/warlock.webp',
            'Waterworks': '/assets/maps/waterworks.webp',
            'Zanzibar': '/assets/maps/zanzibar.webp',
            'Containment': '/assets/maps/containment.webp',
            'Elongation': '/assets/maps/elongation.webp',
            'Gemini': '/assets/maps/gemini.webp',
            'Relic': '/assets/maps/relic.webp',
            'Terminal': '/assets/maps/terminal.webp',
            'Backwash': '/assets/maps/backwash.webp',
            'Desolation': '/assets/maps/desolation.webp',
            'Tombstone': '/assets/maps/tombstone.webp',
            'District': '/assets/maps/district.webp',
            'Uplift': '/assets/maps/uplift.webp'
        };
        const defaultMapImage = '/assets/maps/default.webp';

        // Get playlist name from URL path
        function getPlaylistName() {
            const path = window.location.pathname;
            let name = path.replace(/^\/playlist\//, '').replace(/^\//, '').replace(/\/$/, '');
            name = decodeURIComponent(name);
            if (!name || name === 'playlist.html') {
                const params = new URLSearchParams(window.location.search);
                name = params.get('name') || params.get('playlist') || '';
            }
            return name;
        }

        // Rank icon mapping (1-3 for team placement, 1-50 for player rank)
        function getRankIcon(rank) {
            if (rank >= 1 && rank <= 50) {
                return `/assets/ranks/${rank}.webp`;
            }
            return null;
        }

        // Data storage
        let playersData = [];
        let matchesData = [];
        let teamsData = [];
        let emblemsData = {};
        let mmrData = {};
        let playlistConfig = null;
        let currentSort = { column: 'wins', direction: 'desc' };

        // Player stats columns (no XP)
        const columns = [
            { key: 'player', label: 'Player', sortable: true },
            { key: 'record', label: 'Record', sortable: true, sortKey: 'wins' },
            { key: 'winRate', label: 'Win %', sortable: true },
            { key: 'kills', label: 'Kills', sortable: true },
            { key: 'deaths', label: 'Deaths', sortable: true },
            { key: 'kd', label: 'K/D', sortable: true },
            { key: 'assists', label: 'Assists', sortable: true },
            { key: 'headshots', label: 'Headshots', sortable: true }
        ];

        function switchPlaylistTab(tabName) {
            document.querySelectorAll('.playlist-tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.playlist-tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // Team detection - find teams based on same 4 players playing together
        function detectTeams(matches) {
            const teamMap = {}; // key: sorted player names, value: { players, wins, losses, games }

            for (const match of matches) {
                const redTeam = match.red_team || [];
                const blueTeam = match.blue_team || [];
                const winner = match.winner;

                // Process red team
                if (redTeam.length === 4) {
                    const teamKey = [...redTeam].sort().join('|');
                    if (!teamMap[teamKey]) {
                        teamMap[teamKey] = { players: redTeam, wins: 0, losses: 0, games: [] };
                    }
                    if (winner === 'Red') {
                        teamMap[teamKey].wins++;
                    } else {
                        teamMap[teamKey].losses++;
                    }
                    teamMap[teamKey].games.push(match);
                }

                // Process blue team
                if (blueTeam.length === 4) {
                    const teamKey = [...blueTeam].sort().join('|');
                    if (!teamMap[teamKey]) {
                        teamMap[teamKey] = { players: blueTeam, wins: 0, losses: 0, games: [] };
                    }
                    if (winner === 'Blue') {
                        teamMap[teamKey].wins++;
                    } else {
                        teamMap[teamKey].losses++;
                    }
                    teamMap[teamKey].games.push(match);
                }
            }

            // Convert to array and determine team names (captain = highest MMR)
            const teams = Object.values(teamMap).map(team => {
                // Find captain (highest MMR)
                let captain = team.players[0];
                let highestMMR = 0;

                for (const player of team.players) {
                    const playerMMR = getPlayerMMR(player);
                    if (playerMMR > highestMMR) {
                        highestMMR = playerMMR;
                        captain = player;
                    }
                }

                return {
                    name: `Team ${captain}`,
                    captain: captain,
                    players: team.players,
                    wins: team.wins,
                    losses: team.losses,
                    games: team.games
                };
            });

            // Sort by wins descending
            teams.sort((a, b) => b.wins - a.wins || a.losses - b.losses);

            return teams;
        }

        function getPlayerMMR(playerName) {
            // Search MMR data by discord_name
            for (const [id, data] of Object.entries(mmrData)) {
                if (data.discord_name && data.discord_name.toLowerCase() === playerName.toLowerCase()) {
                    return data.mmr || 0;
                }
            }
            return 0;
        }

        function renderTeamsTable() {
            const tbody = document.getElementById('teamsTableBody');
            tbody.innerHTML = teamsData.map((team, index) => {
                const placement = index + 1;
                const rankIcon = placement <= 3 ? getRankIcon(placement) : null;
                const winRate = ((team.wins / Math.max(1, team.wins + team.losses)) * 100).toFixed(1);

                const playersHtml = team.players.map(p =>
                    `<span class="player-link" onclick="goToPlayer('${p}')">${p}</span>`
                ).join(', ');

                return `
                    <tr>
                        <td>
                            <div class="placement-cell">
                                ${rankIcon ? `<img src="${rankIcon}" class="placement-icon" alt="Place ${placement}">` : ''}
                                <span>${placement}</span>
                            </div>
                        </td>
                        <td>
                            <div class="team-name">${team.name}</div>
                            <div class="team-players">${playersHtml}</div>
                        </td>
                        <td>${team.wins}-${team.losses}</td>
                        <td>${winRate}%</td>
                    </tr>
                `;
            }).join('');
        }

        function renderHeader() {
            const headerRow = document.getElementById('tableHeader');
            headerRow.innerHTML = columns.map(col => {
                const sortClass = currentSort.column === col.key ?
                    (currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : '';
                return `<th class="${sortClass}" onclick="sortBy('${col.key}')">${col.label}</th>`;
            }).join('');
        }

        function sortBy(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'desc';
            }
            renderPlayersTable();
        }

        function getSortValue(player, column) {
            switch (column) {
                case 'player': return player.discord_name.toLowerCase();
                case 'record':
                case 'wins': return player.wins || 0;
                case 'winRate': return player.wins / Math.max(1, player.wins + player.losses);
                case 'kills': return player.kills || 0;
                case 'deaths': return player.deaths || 0;
                case 'kd': return player.kills / Math.max(1, player.deaths);
                case 'assists': return player.assists || 0;
                case 'headshots': return player.headshots || 0;
                default: return 0;
            }
        }

        function renderPlayersTable() {
            renderHeader();

            const sorted = [...playersData].sort((a, b) => {
                const aVal = getSortValue(a, currentSort.column);
                const bVal = getSortValue(b, currentSort.column);
                const modifier = currentSort.direction === 'asc' ? 1 : -1;
                if (typeof aVal === 'string') {
                    return aVal.localeCompare(bVal) * modifier;
                }
                return (bVal - aVal) * modifier;
            });

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = sorted.map(player => {
                const emblem = emblemsData[player.discord_id]?.emblem_url || '';
                const kd = (player.kills / Math.max(1, player.deaths)).toFixed(2);
                const winRate = ((player.wins / Math.max(1, player.wins + player.losses)) * 100).toFixed(1);
                const kdClass = kd >= 1.2 ? 'positive' : kd < 0.8 ? 'negative' : 'neutral';

                return `
                    <tr>
                        <td>
                            <div class="player-cell">
                                ${emblem ? `<img src="${emblem}" class="player-emblem" alt="">` : ''}
                                <span class="player-name" onclick="goToPlayer('${player.discord_name}')">${player.discord_name}</span>
                            </div>
                        </td>
                        <td>${player.wins}-${player.losses}</td>
                        <td>${winRate}%</td>
                        <td>${player.kills || 0}</td>
                        <td>${player.deaths || 0}</td>
                        <td class="${kdClass}">${kd}</td>
                        <td>${player.assists || 0}</td>
                        <td>${player.headshots || 0}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderSummary() {
            const totalGames = matchesData.length;
            const totalKills = playersData.reduce((sum, p) => sum + (p.kills || 0), 0);
            const totalDeaths = playersData.reduce((sum, p) => sum + (p.deaths || 0), 0);
            const avgKd = (totalKills / Math.max(1, totalDeaths)).toFixed(2);

            const summary = document.getElementById('playlistSummary');
            summary.innerHTML = `
                <div class="summary-stat">
                    <div class="value">${teamsData.length}</div>
                    <div class="label">Teams</div>
                </div>
                <div class="summary-stat">
                    <div class="value">${playersData.length}</div>
                    <div class="label">Players</div>
                </div>
                <div class="summary-stat">
                    <div class="value">${totalGames}</div>
                    <div class="label">Games Played</div>
                </div>
                <div class="summary-stat">
                    <div class="value">${totalKills.toLocaleString()}</div>
                    <div class="label">Total Kills</div>
                </div>
            `;
        }

        // Format duration
        function formatDuration(duration) {
            if (!duration) return '0:00';
            return duration;
        }

        // Format date/time
        function formatDateTime(startTime) {
            if (!startTime) return '';
            try {
                const date = new Date(startTime);
                if (isNaN(date.getTime())) return startTime;
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit'
                });
            } catch (e) {
                return startTime;
            }
        }

        // Get base gametype name (matches MLG 4v4/Team Hardcore naming conventions)
        function getBaseGametype(variantName, playlist = '') {
            if (!variantName) return 'Unknown';
            const name = variantName.toLowerCase();
            // MLG/Tournament playlists use "Bomb" for assault
            const isMLG = playlist === 'MLG 4v4' || playlist === 'Team Hardcore' ||
                          playlist.toLowerCase().includes('tournament');

            // CTF variants
            if (name.includes('flag') || name.includes('ctf')) {
                return 'Capture the Flag';
            }
            // Oddball variants
            if (name.includes('oddball') || name.includes('ball') || name.includes('bawl')) {
                return 'Oddball';
            }
            // King of the Hill variants
            if (name.includes('king') || name.includes('koth') || name.includes('hill')) {
                return 'King of the Hill';
            }
            // Assault variants - "Bomb" for MLG/Tournament, "Assault" for others
            if (name.includes('assault') || name.includes('bomb')) {
                return isMLG ? 'Bomb' : 'Assault';
            }
            // Territories variants
            if (name.includes('territor')) {
                return 'Territories';
            }
            // FFA / Slayer variants
            if (name.includes('ffa') || name.includes('free for all') || name.includes('rumble')) {
                return 'Free For All';
            }
            // Slayer
            if (name.includes('slayer') || name.includes(' ts') || name === 'ts' || name.endsWith('ts')) {
                return 'Team Slayer';
            }
            // Default: return original
            return variantName;
        }

        // Get gametype with playlist prefix (MLG, 2v2, 1v1)
        function getGametypeWithPrefix(gameType, playlist) {
            if (!playlist) return gameType;

            const playlistLower = playlist.toLowerCase();
            if (playlistLower === 'mlg 4v4' || playlistLower === 'team hardcore' ||
                playlistLower.includes('tournament')) {
                return 'MLG ' + gameType;
            } else if (playlistLower === 'double team') {
                return '2v2 ' + gameType;
            } else if (playlistLower === 'head to head') {
                return '1v1 ' + gameType;
            }
            return gameType;
        }

        // Get full display gametype (base + prefix)
        function getDisplayGametype(variantName, playlist) {
            const baseType = getBaseGametype(variantName, playlist);
            return getGametypeWithPrefix(baseType, playlist);
        }

        // Render games list (mirrors main page)
        function renderGamesList() {
            const gamesList = document.getElementById('playlistGamesList');
            if (!gamesList || matchesData.length === 0) {
                if (gamesList) gamesList.innerHTML = '<div class="loading-message">No games to display</div>';
                return;
            }

            gamesList.innerHTML = '';

            // Sort by timestamp (newest first)
            const sortedMatches = [...matchesData].sort((a, b) => {
                const dateA = new Date(a.timestamp || 0);
                const dateB = new Date(b.timestamp || 0);
                return dateB - dateA;
            });

            sortedMatches.forEach((match, index) => {
                const gameItem = createGameItem(match, index);
                gamesList.appendChild(gameItem);
            });
        }

        function createGameItem(match, gameIndex) {
            const gameDiv = document.createElement('div');
            gameDiv.className = 'game-item';
            gameDiv.id = `playlist-game-${gameIndex}`;
            gameDiv.setAttribute('data-game-index', gameIndex);

            const mapName = match.map || 'Unknown Map';
            const rawGametype = match.gametype || 'Unknown';
            const gametype = getDisplayGametype(rawGametype, playlistConfig?.name || '');
            const duration = formatDuration(match.duration);
            const dateDisplay = formatDateTime(match.timestamp);
            const mapImage = mapImages[mapName] || defaultMapImage;

            // Determine winner and score display
            let winnerClass = '';
            let scoreTagClass = '';
            let teamScoreDisplay = '';

            if (match.red_score !== undefined && match.blue_score !== undefined) {
                if (match.winner === 'Red') {
                    winnerClass = 'winner-red';
                    scoreTagClass = 'score-tag-red';
                } else if (match.winner === 'Blue') {
                    winnerClass = 'winner-blue';
                    scoreTagClass = 'score-tag-blue';
                }
                teamScoreDisplay = `<span class="game-meta-tag ${scoreTagClass}">Red: ${match.red_score} - Blue: ${match.blue_score}</span>`;
            }

            gameDiv.innerHTML = `
                <div class="game-header-bar ${winnerClass}" onclick="toggleGameDetails(${gameIndex})">
                    <div class="game-header-left">
                        <div class="game-info">
                            <span class="game-type-title">${gametype}</span>
                            <span class="game-meta-tag">${mapName}</span>
                            ${teamScoreDisplay}
                        </div>
                    </div>
                    <div class="game-header-right">
                        ${dateDisplay ? `<span class="game-meta-tag date-tag">${dateDisplay}</span>` : ''}
                        <div class="expand-icon">â–¶</div>
                    </div>
                </div>
                <div class="game-details">
                    <div class="game-details-content">
                        <div id="playlist-game-content-${gameIndex}"></div>
                    </div>
                </div>
            `;

            return gameDiv;
        }

        function toggleGameDetails(gameIndex) {
            const gameItem = document.getElementById(`playlist-game-${gameIndex}`);
            const gameContent = document.getElementById(`playlist-game-content-${gameIndex}`);

            if (!gameItem) return;

            const isExpanded = gameItem.classList.contains('expanded');

            if (isExpanded) {
                gameItem.classList.remove('expanded');
            } else {
                gameItem.classList.add('expanded');

                if (!gameContent.innerHTML) {
                    const match = matchesData.find((m, i) => {
                        // Find match by sorted order
                        const sortedMatches = [...matchesData].sort((a, b) => {
                            const dateA = new Date(a.timestamp || 0);
                            const dateB = new Date(b.timestamp || 0);
                            return dateB - dateA;
                        });
                        return sortedMatches[gameIndex] === m;
                    }) || matchesData[gameIndex];

                    if (match) {
                        gameContent.innerHTML = renderGameContent(match, gameIndex);
                    }
                }
            }
        }

        function renderGameContent(match, gameIndex) {
            const mapName = match.map || 'Unknown';
            const mapImage = mapImages[mapName] || defaultMapImage;
            const rawGametype = match.gametype || 'Unknown';
            const gametype = getDisplayGametype(rawGametype, playlistConfig?.name || '');
            const duration = formatDuration(match.duration);
            const formattedTime = formatDateTime(match.timestamp);

            // Team scores
            let teamScoreHtml = '';
            if (match.red_score !== undefined && match.blue_score !== undefined) {
                const redWinner = match.winner === 'Red';
                const blueWinner = match.winner === 'Blue';
                teamScoreHtml = '<div class="game-final-score">';
                teamScoreHtml += `<span class="final-score-team team-red${redWinner ? ' winner' : ''}">Red: ${match.red_score}</span>`;
                teamScoreHtml += '<span class="score-separator">vs</span>';
                teamScoreHtml += `<span class="final-score-team team-blue${blueWinner ? ' winner' : ''}">Blue: ${match.blue_score}</span>`;
                teamScoreHtml += '</div>';
            }

            let html = '<div class="game-details-header">';
            html += `<div class="map-image-container">`;
            html += `<img src="${mapImage}" alt="${mapName}" class="map-image" onerror="this.src='${defaultMapImage}'">`;
            html += `<div class="map-overlay">`;
            html += `<div class="map-name">${mapName}</div>`;
            html += `</div>`;
            html += `</div>`;
            html += `<div class="game-info-panel">`;
            html += `<div class="game-type-title">${gametype}</div>`;
            html += `<div class="game-meta-info">`;
            html += `<span><i class="icon-clock"></i> ${duration}</span>`;
            html += `<span><i class="icon-calendar"></i> ${formattedTime}</span>`;
            const playlistName = playlistConfig?.name || '';
            if (playlistName) {
                html += `<a href="/playlist.html?name=${encodeURIComponent(playlistName)}" class="playlist-link" onclick="event.stopPropagation();">${playlistName}</a>`;
            }
            html += `</div>`;
            html += teamScoreHtml;
            html += `</div>`;

            // Theater and download buttons
            html += '<div class="game-actions">';
            if (match.theater_url) {
                html += `<button class="replay-3d-btn" onclick="event.stopPropagation(); openTheater('${match.theater_url}');" title="Halo 2 Theater Mode">`;
                html += '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5"></path><path d="M2 12l10 5 10-5"></path></svg>';
                html += '<span>Halo 2 Theater Mode</span>';
                html += '</button>';
            }

            html += '<div class="game-download-dropdown">';
            html += '<button class="download-icon-btn" onclick="event.stopPropagation(); this.nextElementSibling.classList.toggle(\'show\');" title="Download game files">';
            html += '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>';
            html += '</button>';
            html += '<div class="download-menu">';
            if (match.public_url) {
                const statsFilename = match.public_url.split('/').pop();
                html += `<a href="${match.public_url}" class="download-menu-item" download="${statsFilename}" onclick="event.stopPropagation();">Stats</a>`;
            } else {
                html += '<span class="download-menu-item disabled" onclick="event.stopPropagation();">Stats N/A</span>';
            }
            if (match.theater_url) {
                const telemetryFilename = match.theater_url.split('/').pop();
                html += `<a href="${match.theater_url}" class="download-menu-item" download="${telemetryFilename}" onclick="event.stopPropagation();">Telemetry</a>`;
            } else {
                html += '<span class="download-menu-item disabled" onclick="event.stopPropagation();">Telemetry N/A</span>';
            }
            html += '</div>';
            html += '</div>';
            html += '</div>';

            html += '</div>';

            // Scoreboard
            html += '<div class="tab-navigation">';
            html += `<button class="tab-btn active" onclick="switchGameTab(this, 'scoreboard', ${gameIndex})">Scoreboard</button>`;
            html += '</div>';

            html += '<div class="tab-content active">';
            html += renderScoreboard(match);
            html += '</div>';

            return html;
        }

        function switchGameTab(btn, tabName, gameIndex) {
            const parent = btn.closest('.game-details-content');
            const tabs = parent.querySelectorAll('.tab-content');
            const buttons = parent.querySelectorAll('.tab-btn');

            buttons.forEach(b => b.classList.remove('active'));
            tabs.forEach(t => t.classList.remove('active'));

            btn.classList.add('active');
            const tabIndex = Array.from(buttons).indexOf(btn);
            tabs[tabIndex].classList.add('active');
        }

        function renderScoreboard(match) {
            const players = match.player_stats || [];

            // Sort: Red team first, then Blue
            const sortedPlayers = [...players].sort((a, b) => {
                const teamOrder = { 'Red': 0, 'Blue': 1 };
                const teamA = teamOrder[a.team] !== undefined ? teamOrder[a.team] : 2;
                const teamB = teamOrder[b.team] !== undefined ? teamOrder[b.team] : 2;
                return teamA - teamB;
            });

            let html = '<div class="scoreboard">';
            html += '<table class="scoreboard-table">';
            html += '<thead><tr>';
            html += '<th>Player</th>';
            html += '<th>K</th>';
            html += '<th>D</th>';
            html += '<th>A</th>';
            html += '<th>Score</th>';
            html += '</tr></thead>';
            html += '<tbody>';

            sortedPlayers.forEach(player => {
                const teamClass = player.team ? `team-${player.team.toLowerCase()}` : '';
                const emblemUrl = emblemsData[player.discord_id]?.emblem_url || '';

                html += `<tr class="${teamClass}">`;
                html += `<td class="player-cell">`;
                if (emblemUrl) {
                    html += `<img src="${emblemUrl}" class="player-emblem scoreboard-emblem" alt="">`;
                }
                html += `<span class="player-name clickable-player" onclick="goToPlayer('${player.name}')">${player.name}</span>`;
                html += `</td>`;
                html += `<td>${player.kills || 0}</td>`;
                html += `<td>${player.deaths || 0}</td>`;
                html += `<td>${player.assists || 0}</td>`;
                html += `<td>${player.score || 0}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            html += '</div>';

            return html;
        }

        function openTheater(url) {
            // Open theater view - could be integrated with main site's theater
            window.open(url, '_blank');
        }

        function goToPlayer(playerName) {
            window.location.href = `/?player=${encodeURIComponent(playerName)}`;
        }

        // Calculate stats from matches data
        function calculateStatsFromMatches(matchesArray) {
            const playerStats = {};

            for (const match of matchesArray) {
                const winner = match.winner;

                for (const playerStat of match.player_stats || []) {
                    const name = playerStat.name;
                    if (!playerStats[name]) {
                        playerStats[name] = {
                            discord_name: name,
                            wins: 0,
                            losses: 0,
                            kills: 0,
                            deaths: 0,
                            assists: 0,
                            headshots: 0
                        };
                    }

                    const p = playerStats[name];
                    p.kills += playerStat.kills || 0;
                    p.deaths += playerStat.deaths || 0;
                    p.assists += playerStat.assists || 0;
                    p.headshots += playerStat.headshots || 0;

                    if (playerStat.team === winner) {
                        p.wins++;
                    } else {
                        p.losses++;
                    }
                }
            }

            return { players: playerStats };
        }

        async function loadPlaylistStats() {
            const playlistName = getPlaylistName();

            if (!playlistName) {
                showError('No playlist specified in URL.');
                return;
            }

            document.title = `${playlistName} - CarnageReport.com`;

            try {
                // Load playlists config
                const playlistsResponse = await fetch('playlists.json');
                if (!playlistsResponse.ok) {
                    throw new Error('Could not load playlists config');
                }
                const playlistsConfig = await playlistsResponse.json();

                // Find the playlist by name (case-insensitive)
                playlistConfig = playlistsConfig.playlists.find(p =>
                    p.name.toLowerCase() === playlistName.toLowerCase()
                );

                if (!playlistConfig) {
                    throw new Error(`Playlist "${playlistName}" not found`);
                }

                // Load MMR data for team captain detection
                try {
                    const mmrResponse = await fetch('MMR.json');
                    if (mmrResponse.ok) {
                        mmrData = await mmrResponse.json();
                    }
                } catch (e) {
                    console.warn('Could not load MMR data:', e);
                }

                // Load matches data
                const matchesResponse = await fetch(playlistConfig.matches_file);
                if (!matchesResponse.ok) {
                    throw new Error(`Matches data for "${playlistName}" not found`);
                }
                const matchesJson = await matchesResponse.json();
                matchesData = matchesJson.matches || [];

                // Calculate player stats from matches
                const statsData = calculateStatsFromMatches(matchesData);

                // Detect teams
                teamsData = detectTeams(matchesData);

                // Load emblems
                try {
                    const emblemsResponse = await fetch('emblems.json');
                    if (emblemsResponse.ok) {
                        emblemsData = await emblemsResponse.json();
                    }
                } catch (e) {
                    console.warn('Could not load emblems:', e);
                }

                // Convert players object to array
                playersData = Object.entries(statsData.players || {}).map(([discordId, data]) => ({
                    discord_id: discordId,
                    ...data
                }));

                // Show content
                document.getElementById('loadingArea').style.display = 'none';
                document.getElementById('contentArea').style.display = 'block';
                document.getElementById('playlistName').textContent = playlistName;

                // Show date if available
                if (playlistConfig.date) {
                    document.getElementById('playlistDate').textContent = playlistConfig.date;
                }

                // Hide tabs for non-tournament playlists (no team detection needed)
                if (!playlistName.toLowerCase().includes('tournament')) {
                    document.getElementById('playlistTabs').style.display = 'none';
                    document.getElementById('tab-players').classList.add('active');
                    document.getElementById('tab-teams').classList.remove('active');
                }

                renderSummary();
                renderTeamsTable();
                renderPlayersTable();
                renderGamesList();

            } catch (error) {
                showError(error.message);
            }
        }

        function showError(message) {
            document.getElementById('loadingArea').style.display = 'none';
            document.getElementById('errorArea').style.display = 'block';
            document.getElementById('errorText').textContent = message;
        }

        // Close download menus when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.game-download-dropdown')) {
                document.querySelectorAll('.download-menu.show').forEach(m => {
                    m.classList.remove('show');
                });
            }
        });

        // Load on page ready
        document.addEventListener('DOMContentLoaded', loadPlaylistStats);
    </script>
</body>
</html>
